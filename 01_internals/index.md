---
layout: post
title: Под капотом у Hello World.
highlight: true
---

В этом уроке мы на примере простейшего Android приложения, созданного в [предыдущем уроке](../01_hello_world), подробно изучим устройство проекта, его сборку, попробуем базовые инструменты разработки и отладки, которые пригодядтся в дальнейшем.

## Устройство проекта

В [прошлом уроке](../01_hello_world/) мы уже сделали краткий обзор структуры проекта, но тогда мы больше внимания уделили файлам с исходным кодом. Сейчас мы подробнее рассмотрим файлы, о которых в прошлый раз упоминули лишь вскользь.

### Build скрипты

Стандартная система сборки Android приложений основана на Gradle (https://gradle.org/) -- опенсорнсом инструменте для сборки общего назначения -- и плагине для Gradle, который знает, как собирать Android проекты. Вам не нужно устанавливать эти инструменты, потому что система сборки устроена так, что всё необходимое скачивается и устанавливается во время сборки  (удобно, но требует подключения к Интернету во время сборки). Однако, если по каким-то причинам, вы хотите использовать предустановленный дистрибутив Gradle, вы можете указать путь к нему в настройках Android Studio (*Use local Gradle distribution* в разделе *Build, Execution, Deployment / Gradle* настроек).

<img src="img/0600_gradle_settings.png" width="800px"/>

Стандартная конфигурация системы сборки включает использование Gradle Wrapper. Для этого в проекте есть специальные файлы:
```
<project_dir>/
	gradlew
    gradlew.bat
    gradle/wrapper/
    	gradle-wrapper.jar
        gradle-wrapper.properties
```

**gradlew** и **gradlew.bat** -- это скрипты для запуска Gradle Wrapper для Linux подобных систем и для Windows. Gradle Wrapper является Java приложением и находится в файле **gradle-wrapper.jar**. Очевидно, что для запуска сборки необходима установленная Java -- она входит в комплект установки Android Studio.

Файл **gradle-wrapper.properties** содержит самые общие параметры запуска Gradle, и, наверно, единственный параметр, который вам может понадобиться менять -- это версия Gradle в параметре `distributionUrl`. Если вы долго работаете над одним проектом, то за время работы может появиться более новая версия Gradle, и тогда, чтобы перейти на неё, вам придется подредактировать `gradle-wrapper.properties`.

После старта Gradle Wrapper при необходимости скачивает необходимую версию Gradle и запускает его, чтобы тот занялся уже непосредственно сборкой проекта. За сборку проекта отвечают следующие файлы:

```
<project_dir>/
	build.gradle
    settings.gradle
    gradle.properties
    local.properties
    app/
    	build.gradle
```

Начнем с **local.properties** -- в этом файле определены свойства, значения которых имеют смысл только на вашей машине, на которой вы запускаете сборку. Это, прежде всего, `sdk.dir` -- путь к установленному Android SDK. Файл `local.properties` должен быть свой у каждого разработчика, который работает над проектом, и его не надо коммитить в общий репозиторий. Если в вашем проекте нет других настроек, зависящих от машины, на которой запускается сборка, то проще определить переменную окружения `ANDROID_HOME` -- тогда файл `local.properties` вообще не будет нужен.

Файл **gradle.properties** содержит настройки, которые используется при сборке проекта. В новом проект там обычно определено свойство `org.gradle.jvmargs`, в котором прописан параметр `-Xmx` для запуска JVM. Сборка Android приложений требует много памяти, особенно, если проект большой (а большим проект может стать очень быстро), поэтому, когда заметите, что сборка стала сильно тормозить, проверьте -- не упирается ли она в память, и не надо ли увеличить `-Xmx`. Впрочем, оптимизация и ускорение сборки Android проектов это отдельная сложная тема, и одним параметром `-Xmx` вопрос не ограничивается.

Файл **settings.gradle** обычно определяет структуру проекта. В новом проекте приложения типа Hello World, содержимое этого файла выглядит так:
```
include ':app'
```
Здесь указан единственный модуль, из которого состоит проект. Если модулей больше -- они перечисляются через запятую: `include ':app', ':module1', 'module2'`.

Файл **build.gradle** в корне проекта уже содержит какое-то "мясо" -- здесь описывается сборка всего проекта на уровне, общем для всех модулей. Файл начинается со следующего блока:
```
buildscript {
    repositories {
        google()
        jcenter()
    }
    dependencies {
        classpath 'com.android.tools.build:gradle:3.3.0'
    }
}
```
Главное здесь -- объявление зависимости на Android Gradle плагин: `com.android.tools.build:gradle:3.3.0`, который непосредственно отвечает за сборку Android приложения. Вам может понадобиться подредактировать здесь его версию, если во время работы над проектом вышла новая версия плагина с каким-то новыми фичами или оптимизациями, и вы хотите её использовать. Репозитории google и jcenter, прописанные в этом блоке нужны для поиска там указанной версии плагина. Обратите внимание -- эти репозитории относятся только к блоку `buildscript`, то есть к системе сборки, но они не относятся к зависимостям вашего приложения, которые вы используете в коде.

Репозитории для поиска зависимостей приложения определены в следующем блоке:
```
allprojects {
    repositories {
        google()
        jcenter()
    }
}
```
Слово `allproject` говорит о том, что этот блок применяется ко всем модулям проекта, и вам не надо прописывать эти репозитории в каждом отдельном модуле.

Файл **app/build.gradle**, который лежит в папке модуля приложения app, описывает сборку этого модуля, а так как этот модуль содержит само приложение, в этом билд скрипте содержится всё самое интересное. Первая его строчка
```
apply plugin: 'com.android.application'
```
определяет, что перед нами модуль, содержащий Android приложение, и для его сборки будет использовать Android Gradle плагин. Другой возможный вариант -- это `com.android.library` для библиотечных модулей. Обычно Android проект содержит один модуль приложения и любое количество библиотечных модулей.

Затем идет блок `android`, в котором определены основные параметры приложения:
```
android {
    compileSdkVersion 28
    defaultConfig {
        applicationId "ru.ok.technopolis.helloworld"
        minSdkVersion 19
        targetSdkVersion 28
        versionCode 1
        versionName "1.0"
        testInstrumentationRunner "android.support.test.runner.AndroidJUnitRunner"
    }
    buildTypes {
        release {
            minifyEnabled false
            proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
        }
    }
}
```

**applicationId** -- это ID, по которому приложения идентифицируются в операционной системе Android и в магазинах приложений вроде Google Play. Этот ID мы указывали при создании проекта в Android Studio.

**versionName** -- это версия приложения, как её будут видеть пользователи, например, на странице приложения в Google Play или в системных настройках Android устройства в информации о приложении. Значение `versionName` может быть любым, но обычно это числа, разделенные точками: `1.0`, `1.1`, `2.0`, `2.0.1` -- это традиционная *семантическая* система нумерации версий. Иногда в **versionName** кодируют дату релиза приложения: `19.1.22` (22 января 2019 года). Могут присутствовать буквы, например: `5.1-alpha`, `19.2.13-debug` и пр. Вообще, `versionName` используется исключительно как текст для отображения пользователям.

**versionCode** -- это тоже версия приложения, но, в отличие от `versionName`, имеет значение типа `int` и используется для алгоритмической обработки и в бизнес-логике приложения. Допустимые значения: положительные целые числа, обязательно возрастающие с каждой версией приложения. Если вы публикуете приложение в магазине приложений, то в каждом следующем обновлении должно быть большее значение `versionCode`.






## Сборка проекта
## R файл
## Лишние файлы
## Логирование и BuildConfig файл
## Падение приложения
## Отладка дебаггером
## Сборка проекта из командной строки -- Gradle
## Запуск приложения из командной строки -- ADB

